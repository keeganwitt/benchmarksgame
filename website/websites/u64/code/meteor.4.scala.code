<span class="hl com">/* The Computer Language Benchmarks Game</span>
<span class="hl com">   http://benchmarksgame.alioth.debian.org/</span>
<span class="hl com">   contributed by Isaac Gouy</span>
<span class="hl com">   updated for 2.8 by Rex Kerr</span>
<span class="hl com">*/</span>

<span class="hl slc">// Most for-comprehension replaced by while loops</span>
<span class="hl slc">// BoardCells occupied by each Piece orientation are cached</span>
<span class="hl slc">// Piece orientations are cached</span>

<span class="hl kwa">import</span> scala<span class="hl opt">.</span>collection<span class="hl opt">.</span>mutable<span class="hl opt">.</span>_

<span class="hl kwa">object</span> meteor <span class="hl opt">{</span>
   <span class="hl kwa">def</span> <span class="hl kwd">main</span><span class="hl opt">(</span>args<span class="hl opt">:</span> Array<span class="hl opt">[</span>String<span class="hl opt">]) = {</span>
      <span class="hl kwa">val</span> solver <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Solver</span><span class="hl opt">(</span> <span class="hl kwd">args</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span>toInt <span class="hl opt">)</span>
      solver<span class="hl opt">.</span>findSolutions
      solver<span class="hl opt">.</span>printSolutions
   <span class="hl opt">}</span>
<span class="hl opt">}</span>


<span class="hl kwa">final class</span> <span class="hl kwd">Solver</span> <span class="hl opt">(</span>n<span class="hl opt">:</span> Int<span class="hl opt">) {</span>
   <span class="hl kwa">private var</span> countdown <span class="hl opt">=</span> n
   <span class="hl kwa">private var</span> first<span class="hl opt">:</span> String <span class="hl opt">=</span> _
   <span class="hl kwa">private var</span> last<span class="hl opt">:</span> String <span class="hl opt">=</span> _

   <span class="hl kwa">private val</span> board <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Board</span><span class="hl opt">()</span>

   <span class="hl kwa">val</span> pieces <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwd">tabulate</span><span class="hl opt">(</span><span class="hl num">10</span><span class="hl opt">)(</span>i <span class="hl opt">=&gt;</span> <span class="hl kwa">new</span> <span class="hl kwd">Piece</span><span class="hl opt">(</span>i<span class="hl opt">))</span>

   <span class="hl kwa">val</span> unplaced <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BitSet</span><span class="hl opt">(</span>pieces<span class="hl opt">.</span>length<span class="hl opt">)</span>

   <span class="hl opt">{</span> unplaced <span class="hl opt">++= (</span><span class="hl num">0</span> until pieces<span class="hl opt">.</span>length<span class="hl opt">) }</span>


   <span class="hl kwa">def</span> <span class="hl kwd">findSolutions</span><span class="hl opt">():</span> Unit <span class="hl opt">= {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>countdown <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span>

      <span class="hl kwa">if</span> <span class="hl opt">(</span>unplaced<span class="hl opt">.</span>size <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">){</span>
         <span class="hl kwa">val</span> emptyCellIndex <span class="hl opt">=</span> board<span class="hl opt">.</span>firstEmptyCellIndex

         <span class="hl kwa">var</span> k <span class="hl opt">=</span> <span class="hl num">0</span>
         <span class="hl kwa">while</span> <span class="hl opt">(</span>k <span class="hl opt">&lt;</span> pieces<span class="hl opt">.</span>length<span class="hl opt">){</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>unplaced<span class="hl opt">.</span><span class="hl kwd">contains</span><span class="hl opt">(</span>k<span class="hl opt">)){</span>
               unplaced <span class="hl opt">-=</span> k

               <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
               <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> Piece<span class="hl opt">.</span>orientations<span class="hl opt">){</span>
                  <span class="hl kwa">val</span> piece <span class="hl opt">=</span> <span class="hl kwd">pieces</span><span class="hl opt">(</span>k<span class="hl opt">).</span>nextOrientation

                  <span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span>
                  <span class="hl kwa">while</span> <span class="hl opt">(</span>j <span class="hl opt">&lt;</span> Piece<span class="hl opt">.</span>size<span class="hl opt">){</span>
                     <span class="hl kwa">if</span> <span class="hl opt">(</span>board<span class="hl opt">.</span><span class="hl kwd">add</span><span class="hl opt">(</span>j<span class="hl opt">,</span>emptyCellIndex<span class="hl opt">,</span>piece<span class="hl opt">)) {</span>

                        <span class="hl kwa">if</span> <span class="hl opt">(!</span>shouldPrune<span class="hl opt">)</span> findSolutions

                        board<span class="hl opt">.</span><span class="hl kwd">remove</span><span class="hl opt">(</span>piece<span class="hl opt">)</span>
                     <span class="hl opt">}</span>
                     j <span class="hl opt">=</span> j <span class="hl opt">+</span> <span class="hl num">1</span>
                  <span class="hl opt">}</span>
                  i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
               <span class="hl opt">}</span>
               unplaced <span class="hl opt">+=</span> k
            <span class="hl opt">}</span>
            k <span class="hl opt">=</span> k <span class="hl opt">+</span> <span class="hl num">1</span>
         <span class="hl opt">}</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">else</span> <span class="hl opt">{</span>
         puzzleSolved
      <span class="hl opt">}</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">puzzleSolved</span><span class="hl opt">() = {</span>
      <span class="hl kwa">val</span> b <span class="hl opt">=</span> board<span class="hl opt">.</span>asString
      <span class="hl kwa">if</span> <span class="hl opt">(</span>first <span class="hl opt">==</span> null<span class="hl opt">){</span>
         first <span class="hl opt">=</span> b<span class="hl opt">;</span> last <span class="hl opt">=</span> b
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
         <span class="hl kwa">if</span> <span class="hl opt">(</span>b <span class="hl opt">&lt;</span> first<span class="hl opt">){</span> first <span class="hl opt">=</span> b <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span> <span class="hl kwa">if</span> <span class="hl opt">(</span>b <span class="hl opt">&gt;</span> last<span class="hl opt">){</span> last <span class="hl opt">=</span> b <span class="hl opt">} }</span>
      <span class="hl opt">}</span>
      countdown <span class="hl opt">=</span> countdown <span class="hl opt">-</span> <span class="hl num">1</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">shouldPrune</span><span class="hl opt">():</span> Boolean <span class="hl opt">= {</span>
      board<span class="hl opt">.</span>unmark
      <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> board<span class="hl opt">.</span>cells<span class="hl opt">.</span>length<span class="hl opt">){</span>
         <span class="hl kwa">if</span> <span class="hl opt">(</span>board<span class="hl opt">.</span><span class="hl kwd">cells</span><span class="hl opt">(</span>i<span class="hl opt">).</span>contiguousEmptyCells <span class="hl opt">%</span> Piece<span class="hl opt">.</span>size <span class="hl opt">!=</span> <span class="hl num">0</span><span class="hl opt">)</span> <span class="hl kwa">return</span> true
         i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
      <span class="hl opt">}</span>
      false
   <span class="hl opt">}</span>


   <span class="hl kwa">def</span> <span class="hl kwd">printSolutions</span><span class="hl opt">() = {</span>

      <span class="hl kwa">def</span> <span class="hl kwd">printBoard</span><span class="hl opt">(</span>s<span class="hl opt">:</span> String<span class="hl opt">) = {</span>
         <span class="hl kwa">var</span> indent <span class="hl opt">=</span> false
         <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
         <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> s<span class="hl opt">.</span>length<span class="hl opt">){</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>indent<span class="hl opt">)</span> <span class="hl kwd">print</span><span class="hl opt">(</span><span class="hl str">' '</span><span class="hl opt">)</span>
            <span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span>
            <span class="hl kwa">while</span> <span class="hl opt">(</span>j <span class="hl opt">&lt;</span> Board<span class="hl opt">.</span>cols<span class="hl opt">){</span>
               <span class="hl kwd">print</span><span class="hl opt">(</span>s<span class="hl opt">.</span><span class="hl kwd">charAt</span><span class="hl opt">(</span>i<span class="hl opt">));</span> <span class="hl kwd">print</span><span class="hl opt">(</span><span class="hl str">' '</span><span class="hl opt">)</span>
               j <span class="hl opt">=</span> j <span class="hl opt">+</span> <span class="hl num">1</span>
               i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
            <span class="hl opt">}</span>
            <span class="hl kwd">print</span><span class="hl opt">(</span><span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl opt">)</span>
            indent <span class="hl opt">= !</span>indent
         <span class="hl opt">}</span>
         <span class="hl kwd">print</span><span class="hl opt">(</span><span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl opt">)</span>
      <span class="hl opt">}</span>

      <span class="hl kwd">print</span><span class="hl opt">(</span>n <span class="hl opt">+</span> <span class="hl str">&quot; solutions found</span><span class="hl esc">\n\n</span><span class="hl str">&quot;</span><span class="hl opt">)</span>
      <span class="hl kwd">printBoard</span><span class="hl opt">(</span>first<span class="hl opt">)</span>
      <span class="hl kwd">printBoard</span><span class="hl opt">(</span>last<span class="hl opt">)</span>
   <span class="hl opt">}</span>

<span class="hl com">/*</span>
<span class="hl com">   def printPieces() =</span>
<span class="hl com">      for (i &lt;- Iterator.range(0,Board.pieces)) pieces(i).print</span>
<span class="hl com">*/</span>

<span class="hl opt">}</span>



<span class="hl slc">// Board.scala</span>
<span class="hl slc">// import scala.collection.mutable._</span>

<span class="hl kwa">object</span> Board <span class="hl opt">{</span>
   <span class="hl kwa">val</span> cols <span class="hl opt">=</span> <span class="hl num">5</span>
   <span class="hl kwa">val</span> rows <span class="hl opt">=</span> <span class="hl num">10</span>
   <span class="hl kwa">val</span> size <span class="hl opt">=</span> rows <span class="hl opt">*</span> cols
   <span class="hl kwa">val</span> pieces <span class="hl opt">=</span> <span class="hl num">10</span>
   <span class="hl kwa">val</span> noFit <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">[</span>BoardCell<span class="hl opt">](</span><span class="hl num">0</span><span class="hl opt">)</span>
<span class="hl opt">}</span>

<span class="hl kwa">final class</span> Board <span class="hl opt">{</span>
   <span class="hl kwa">val</span> cells <span class="hl opt">=</span> <span class="hl kwd">boardCells</span><span class="hl opt">()</span>

   <span class="hl kwa">val</span> cellsPieceWillFill <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">[</span>BoardCell<span class="hl opt">](</span>Piece<span class="hl opt">.</span>size<span class="hl opt">)</span>
   <span class="hl kwa">var</span> cellCount <span class="hl opt">=</span> <span class="hl num">0</span>

   <span class="hl kwa">def</span> <span class="hl kwd">unmark</span><span class="hl opt">() = {</span>
      <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> cells<span class="hl opt">.</span>length<span class="hl opt">){</span>
         <span class="hl kwd">cells</span><span class="hl opt">(</span>i<span class="hl opt">).</span>unmark
         i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
      <span class="hl opt">}</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">def</span> <span class="hl kwd">asString</span><span class="hl opt">() =</span>
      <span class="hl kwa">new</span> <span class="hl kwd">String</span><span class="hl opt">(</span> cells <span class="hl kwd">map</span><span class="hl opt">(</span>
         c <span class="hl opt">=&gt;</span> <span class="hl kwa">if</span> <span class="hl opt">(</span>c<span class="hl opt">.</span>piece <span class="hl opt">==</span> null<span class="hl opt">)</span> <span class="hl str">'-'</span><span class="hl opt">.</span>toByte
              <span class="hl kwa">else</span> <span class="hl opt">(</span>c<span class="hl opt">.</span>piece<span class="hl opt">.</span>number <span class="hl opt">+</span> <span class="hl num">48</span><span class="hl opt">).</span>toByte <span class="hl opt">))</span>

   <span class="hl kwa">def</span> <span class="hl kwd">firstEmptyCellIndex</span><span class="hl opt">() =</span> cells<span class="hl opt">.</span><span class="hl kwd">findIndexOf</span><span class="hl opt">(</span>c <span class="hl opt">=&gt;</span> c<span class="hl opt">.</span>isEmpty<span class="hl opt">)</span>


   <span class="hl kwa">private val</span> cache <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwd">fill</span><span class="hl opt">(</span>
     Board<span class="hl opt">.</span>pieces<span class="hl opt">,</span>Piece<span class="hl opt">.</span>orientations<span class="hl opt">,</span>Piece<span class="hl opt">.</span>size<span class="hl opt">,</span>Board<span class="hl opt">.</span>size
   <span class="hl opt">)(</span>null<span class="hl opt">:</span> Array<span class="hl opt">[</span>BoardCell<span class="hl opt">])</span>

   <span class="hl kwa">def</span> <span class="hl kwd">add</span><span class="hl opt">(</span>pieceIndex<span class="hl opt">:</span> Int<span class="hl opt">,</span> boardIndex<span class="hl opt">:</span> Int<span class="hl opt">,</span> p<span class="hl opt">:</span> Piece<span class="hl opt">):</span> Boolean <span class="hl opt">= {</span>
      <span class="hl kwa">var</span> a <span class="hl opt">=</span> <span class="hl kwd">cache</span><span class="hl opt">(</span>p<span class="hl opt">.</span>number<span class="hl opt">)(</span>p<span class="hl opt">.</span>orientation<span class="hl opt">)(</span>pieceIndex<span class="hl opt">)(</span>boardIndex<span class="hl opt">)</span>

      cellCount <span class="hl opt">=</span> <span class="hl num">0</span>
      p<span class="hl opt">.</span>unmark

      <span class="hl kwa">if</span> <span class="hl opt">(</span>a <span class="hl opt">==</span> null<span class="hl opt">){</span>
         <span class="hl kwd">find</span><span class="hl opt">(</span>p<span class="hl opt">.</span><span class="hl kwd">cells</span><span class="hl opt">(</span>pieceIndex<span class="hl opt">),</span> <span class="hl kwd">cells</span><span class="hl opt">(</span>boardIndex<span class="hl opt">))</span>

         <span class="hl kwa">if</span> <span class="hl opt">(</span>cellCount <span class="hl opt">!=</span> Piece<span class="hl opt">.</span>size<span class="hl opt">){</span>
            <span class="hl kwd">cache</span><span class="hl opt">(</span>p<span class="hl opt">.</span>number<span class="hl opt">)(</span>p<span class="hl opt">.</span>orientation<span class="hl opt">)(</span>pieceIndex<span class="hl opt">)(</span>boardIndex<span class="hl opt">) =</span> Board<span class="hl opt">.</span>noFit
            <span class="hl kwa">return</span> false
         <span class="hl opt">}</span>

         a <span class="hl opt">=</span> cellsPieceWillFill <span class="hl opt">.</span><span class="hl kwd">filter</span><span class="hl opt">(</span>c <span class="hl opt">=&gt;</span> true<span class="hl opt">)</span>
         <span class="hl kwd">cache</span><span class="hl opt">(</span>p<span class="hl opt">.</span>number<span class="hl opt">)(</span>p<span class="hl opt">.</span>orientation<span class="hl opt">)(</span>pieceIndex<span class="hl opt">)(</span>boardIndex<span class="hl opt">) =</span> a
      <span class="hl opt">}</span>
      <span class="hl kwa">else</span> <span class="hl opt">{</span>
         <span class="hl kwa">if</span> <span class="hl opt">(</span>a <span class="hl opt">==</span> Board<span class="hl opt">.</span>noFit<span class="hl opt">)</span> <span class="hl kwa">return</span> false
      <span class="hl opt">}</span>

      <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length<span class="hl opt">){</span>
         <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">).</span>isEmpty<span class="hl opt">)</span> <span class="hl kwa">return</span> false
         i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
      <span class="hl opt">}</span>

      i <span class="hl opt">=</span> <span class="hl num">0</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> a<span class="hl opt">.</span>length<span class="hl opt">){</span>
         <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">).</span>piece <span class="hl opt">=</span> p
         i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
      <span class="hl opt">}</span>

      true
   <span class="hl opt">}</span>


   <span class="hl kwa">def</span> <span class="hl kwd">remove</span><span class="hl opt">(</span>piece<span class="hl opt">:</span> Piece<span class="hl opt">) = {</span>
      <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> cells<span class="hl opt">.</span>length<span class="hl opt">){</span>
         <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">cells</span><span class="hl opt">(</span>i<span class="hl opt">).</span>piece <span class="hl opt">==</span> piece<span class="hl opt">)</span> <span class="hl kwd">cells</span><span class="hl opt">(</span>i<span class="hl opt">).</span>empty
         i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
      <span class="hl opt">}</span>
   <span class="hl opt">}</span>


   <span class="hl kwa">private def</span> <span class="hl kwd">find</span><span class="hl opt">(</span>p<span class="hl opt">:</span> PieceCell<span class="hl opt">,</span> b<span class="hl opt">:</span> BoardCell<span class="hl opt">):</span> Unit <span class="hl opt">= {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>p <span class="hl opt">!=</span> null <span class="hl opt">&amp;&amp; !</span>p<span class="hl opt">.</span>marked <span class="hl opt">&amp;&amp;</span> b <span class="hl opt">!=</span> null<span class="hl opt">){</span>
         <span class="hl kwd">cellsPieceWillFill</span><span class="hl opt">(</span>cellCount<span class="hl opt">) =</span> b
         cellCount <span class="hl opt">=</span> cellCount <span class="hl opt">+</span> <span class="hl num">1</span>
         p<span class="hl opt">.</span>mark

         <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
         <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> Cell<span class="hl opt">.</span>sides<span class="hl opt">){</span>
            <span class="hl kwd">find</span><span class="hl opt">(</span>p<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>i<span class="hl opt">),</span> b<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>i<span class="hl opt">))</span>
            i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
         <span class="hl opt">}</span>
      <span class="hl opt">}</span>
   <span class="hl opt">}</span>


   <span class="hl kwa">private def</span> <span class="hl kwd">boardCells</span><span class="hl opt">() = {</span>
      <span class="hl kwa">val</span> a <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwd">tabulate</span><span class="hl opt">(</span>Board<span class="hl opt">.</span>size<span class="hl opt">)(</span>i <span class="hl opt">=&gt;</span> <span class="hl kwa">new</span> <span class="hl kwd">BoardCell</span><span class="hl opt">(</span>i<span class="hl opt">))</span>
      <span class="hl kwa">val</span> m <span class="hl opt">= (</span>Board<span class="hl opt">.</span>size <span class="hl opt">/</span> Board<span class="hl opt">.</span>cols<span class="hl opt">) -</span> <span class="hl num">1</span>

      <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;-</span> <span class="hl num">0</span> until a<span class="hl opt">.</span>length<span class="hl opt">) {</span>
         <span class="hl kwa">val</span> row <span class="hl opt">=</span> i <span class="hl opt">/</span> Board<span class="hl opt">.</span>cols
         <span class="hl kwa">val</span> isFirst <span class="hl opt">=</span> i <span class="hl opt">%</span> Board<span class="hl opt">.</span>cols <span class="hl opt">==</span> <span class="hl num">0</span>
         <span class="hl kwa">val</span> isLast <span class="hl opt">= (</span>i<span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">) %</span> Board<span class="hl opt">.</span>cols <span class="hl opt">==</span> <span class="hl num">0</span>
         <span class="hl kwa">val</span> c <span class="hl opt">=</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">)</span>

         <span class="hl kwa">if</span> <span class="hl opt">(</span>row <span class="hl opt">%</span> <span class="hl num">2</span> <span class="hl opt">==</span> <span class="hl num">1</span><span class="hl opt">) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(!</span>isLast<span class="hl opt">)</span> c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">-(</span>Board<span class="hl opt">.</span>cols<span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">))</span>
            c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">-</span>Board<span class="hl opt">.</span>cols<span class="hl opt">)</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>row <span class="hl opt">!=</span> m<span class="hl opt">) {</span>
               <span class="hl kwa">if</span> <span class="hl opt">(!</span>isLast<span class="hl opt">)</span> c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">+(</span>Board<span class="hl opt">.</span>cols<span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">))</span>
               c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">+</span>Board<span class="hl opt">.</span>cols<span class="hl opt">)</span>
            <span class="hl opt">}</span>
         <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>row <span class="hl opt">!=</span> <span class="hl num">0</span><span class="hl opt">) {</span>
               <span class="hl kwa">if</span> <span class="hl opt">(!</span>isFirst<span class="hl opt">)</span> c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">-(</span>Board<span class="hl opt">.</span>cols<span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">))</span>
               c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">-</span>Board<span class="hl opt">.</span>cols<span class="hl opt">)</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>row <span class="hl opt">!=</span> m<span class="hl opt">) {</span>
               <span class="hl kwa">if</span> <span class="hl opt">(!</span>isFirst<span class="hl opt">)</span> c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">+(</span>Board<span class="hl opt">.</span>cols<span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">))</span>
               c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">+</span>Board<span class="hl opt">.</span>cols<span class="hl opt">)</span>
            <span class="hl opt">}</span>
         <span class="hl opt">}</span>
         <span class="hl kwa">if</span> <span class="hl opt">(!</span>isFirst<span class="hl opt">)</span> c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">-</span><span class="hl num">1</span><span class="hl opt">)</span>
         <span class="hl kwa">if</span> <span class="hl opt">(!</span>isLast<span class="hl opt">)</span> c<span class="hl opt">.</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span>i<span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl opt">}</span>
      a
   <span class="hl opt">}</span>


<span class="hl com">/*</span>
<span class="hl com">// Printing all the board cells and their neighbours</span>
<span class="hl com">// helps check that they are connected properly</span>
<span class="hl com"></span>
<span class="hl com">   def printBoardCellsAndNeighbours() = {</span>
<span class="hl com">      println(&quot;cell\tNW NE W  E  SW SE&quot;)</span>
<span class="hl com">      for (i &lt;- 0 until Board.size) {</span>
<span class="hl com">         print(i + &quot;\t&quot;)</span>
<span class="hl com">         for (j &lt;- 0 until Cell.sides) {</span>
<span class="hl com">            val c = cells(i).next(j)</span>
<span class="hl com">            if (c == null)</span>
<span class="hl com">               print(&quot;-- &quot;)</span>
<span class="hl com">            else</span>
<span class="hl com">               printf(&quot;{0,number,00} &quot;)(c.number)</span>
<span class="hl com">         }</span>
<span class="hl com">         println(&quot;&quot;)</span>
<span class="hl com">      }</span>
<span class="hl com">      println(&quot;&quot;)</span>
<span class="hl com">   }</span>
<span class="hl com">*/</span>

<span class="hl opt">}</span>




<span class="hl slc">// Piece.scala</span>

<span class="hl kwa">object</span> Piece <span class="hl opt">{</span>
   <span class="hl kwa">val</span> size <span class="hl opt">=</span> <span class="hl num">5</span>
   <span class="hl kwa">val</span> rotations <span class="hl opt">=</span> Cell<span class="hl opt">.</span>sides
   <span class="hl kwa">val</span> flips <span class="hl opt">=</span> <span class="hl num">2</span>
   <span class="hl kwa">val</span> orientations <span class="hl opt">=</span> rotations <span class="hl opt">*</span> flips
<span class="hl opt">}</span>

<span class="hl kwa">final class</span> <span class="hl kwd">Piece</span><span class="hl opt">(</span>_number<span class="hl opt">:</span> Int<span class="hl opt">) {</span>
   <span class="hl kwa">val</span> number <span class="hl opt">=</span> _number

   <span class="hl kwa">def</span> <span class="hl kwd">unmark</span><span class="hl opt">() = {</span>
      <span class="hl kwa">val</span> c <span class="hl opt">=</span> <span class="hl kwd">cache</span><span class="hl opt">(</span>orientation<span class="hl opt">)</span>
      <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> c<span class="hl opt">.</span>length<span class="hl opt">){</span>
         <span class="hl kwd">c</span><span class="hl opt">(</span>i<span class="hl opt">).</span>unmark
         i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
      <span class="hl opt">}</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">def</span> cells <span class="hl opt">=</span> <span class="hl kwd">cache</span><span class="hl opt">(</span>orientation<span class="hl opt">)</span>

   <span class="hl kwa">private val</span> cache <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwd">tabulate</span><span class="hl opt">(</span>Piece<span class="hl opt">.</span>orientations<span class="hl opt">)(</span>pieceOrientation _<span class="hl opt">)</span>

   <span class="hl kwa">var</span> orientation <span class="hl opt">=</span> <span class="hl num">0</span>

   <span class="hl kwa">def</span> <span class="hl kwd">nextOrientation</span><span class="hl opt">() = {</span>
      orientation <span class="hl opt">= (</span>orientation <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">) %</span> Piece<span class="hl opt">.</span>orientations
      <span class="hl kwa">this</span>
   <span class="hl opt">}</span>


   <span class="hl kwa">private def</span> <span class="hl kwd">pieceOrientation</span><span class="hl opt">(</span>k<span class="hl opt">:</span> Int<span class="hl opt">) = {</span>
      <span class="hl kwa">val</span> cells <span class="hl opt">=</span> Array<span class="hl opt">.</span><span class="hl kwd">fill</span><span class="hl opt">(</span>Piece<span class="hl opt">.</span>size<span class="hl opt">)(</span><span class="hl kwa">new</span> <span class="hl kwd">PieceCell</span><span class="hl opt">())</span>
      <span class="hl kwd">makePiece</span><span class="hl opt">(</span>number<span class="hl opt">,</span>cells<span class="hl opt">)</span>

      <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
      <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> k<span class="hl opt">){</span>
         <span class="hl kwa">if</span> <span class="hl opt">(</span>i <span class="hl opt">%</span> Piece<span class="hl opt">.</span>rotations <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span>
            cells<span class="hl opt">.</span><span class="hl kwd">foreach</span><span class="hl opt">(</span>_<span class="hl opt">.</span>flip<span class="hl opt">)</span>
         <span class="hl kwa">else</span>
            cells<span class="hl opt">.</span><span class="hl kwd">foreach</span><span class="hl opt">(</span>_<span class="hl opt">.</span>rotate<span class="hl opt">)</span>

         i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
      <span class="hl opt">}</span>
      cells
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">makePiece</span><span class="hl opt">(</span>number<span class="hl opt">:</span> Int<span class="hl opt">,</span> cells<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      number match <span class="hl opt">{</span>
         <span class="hl kwa">case</span> <span class="hl num">0</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make0</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">1</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make1</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">2</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make2</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">3</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make3</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">4</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make4</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">5</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make5</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">6</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make6</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">7</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make7</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">8</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make8</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
         <span class="hl kwa">case</span> <span class="hl num">9</span> <span class="hl opt">=&gt;</span> <span class="hl kwd">make9</span><span class="hl opt">(</span>cells<span class="hl opt">)</span>
      <span class="hl opt">}</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make0</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make1</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make2</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make3</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make4</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make5</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make6</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make7</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make8</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

   <span class="hl kwa">private def</span> <span class="hl kwd">make9</span><span class="hl opt">(</span>a<span class="hl opt">:</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">]) = {</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">)</span>
      <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">).</span><span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">a</span><span class="hl opt">(</span><span class="hl num">4</span><span class="hl opt">)</span>
   <span class="hl opt">}</span>

<span class="hl com">/*</span>
<span class="hl com">   def printMe() = {</span>
<span class="hl com">      println(&quot;Piece # &quot; + number)</span>
<span class="hl com">      println(&quot;cell\tNW NE W  E  SW SE&quot;)</span>
<span class="hl com">      for (i &lt;- Iterator.range(0,Piece.size)){</span>
<span class="hl com">         print(i + &quot;\t&quot;)</span>
<span class="hl com">         for (j &lt;- Iterator.range(0,Cell.sides)){</span>
<span class="hl com">            val c = cells(i).next(j)</span>
<span class="hl com">            if (c == null)</span>
<span class="hl com">               print(&quot;-- &quot;)</span>
<span class="hl com">            else</span>
<span class="hl com">               for (k &lt;- Iterator.range(0,Piece.size)){</span>
<span class="hl com">                  if (cells(k) == c) printf(&quot; {0,number,0} &quot;)(k)</span>
<span class="hl com">               }</span>
<span class="hl com">         }</span>
<span class="hl com">         println(&quot;&quot;)</span>
<span class="hl com">      }</span>
<span class="hl com">      println(&quot;&quot;)</span>
<span class="hl com">   }</span>
<span class="hl com">*/</span>
<span class="hl opt">}</span>





<span class="hl slc">// Cell.scala</span>

<span class="hl kwa">object</span> Cell <span class="hl opt">{</span>
   <span class="hl kwa">val</span> NW <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> <span class="hl kwa">val</span> NE <span class="hl opt">=</span> <span class="hl num">1</span>
   <span class="hl kwa">val</span> W  <span class="hl opt">=</span> <span class="hl num">2</span><span class="hl opt">;</span> <span class="hl kwa">val</span> E  <span class="hl opt">=</span> <span class="hl num">3</span>
   <span class="hl kwa">val</span> SW <span class="hl opt">=</span> <span class="hl num">4</span><span class="hl opt">;</span> <span class="hl kwa">val</span> SE <span class="hl opt">=</span> <span class="hl num">5</span>

   <span class="hl kwa">val</span> sides <span class="hl opt">=</span> <span class="hl num">6</span>
<span class="hl opt">}</span>

<span class="hl kwa">abstract class</span> Cell <span class="hl opt">{</span>
   <span class="hl kwa">var</span> marked <span class="hl opt">=</span> false

   <span class="hl kwa">def</span> <span class="hl kwd">mark</span><span class="hl opt">() =</span> marked <span class="hl opt">=</span> true
   <span class="hl kwa">def</span> <span class="hl kwd">unmark</span><span class="hl opt">() =</span> marked <span class="hl opt">=</span> false
<span class="hl opt">}</span>




<span class="hl slc">// BoardCell.scala</span>

<span class="hl kwa">final class</span> <span class="hl kwd">BoardCell</span><span class="hl opt">(</span><span class="hl kwa">val</span> number<span class="hl opt">:</span> Int<span class="hl opt">)</span> <span class="hl kwa">extends</span> Cell <span class="hl opt">{</span>
   <span class="hl kwa">val</span> next <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">[</span>BoardCell<span class="hl opt">](</span>Cell<span class="hl opt">.</span>sides<span class="hl opt">)</span>
   <span class="hl kwa">var</span> piece<span class="hl opt">:</span> Piece <span class="hl opt">=</span> _

   <span class="hl kwa">def</span> <span class="hl kwd">isEmpty</span><span class="hl opt">() =</span> piece <span class="hl opt">==</span> null
   <span class="hl kwa">def</span> <span class="hl kwd">empty</span><span class="hl opt">() =</span> piece <span class="hl opt">=</span> null

   <span class="hl kwa">def</span> <span class="hl kwd">contiguousEmptyCells</span><span class="hl opt">():</span> Int <span class="hl opt">= {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>marked <span class="hl opt">&amp;&amp;</span> isEmpty<span class="hl opt">){</span>
         mark
         <span class="hl kwa">var</span> count <span class="hl opt">=</span> <span class="hl num">1</span>

         <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span>
         <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&lt;</span> next<span class="hl opt">.</span>length<span class="hl opt">){</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">next</span><span class="hl opt">(</span>i<span class="hl opt">) !=</span> null <span class="hl opt">&amp;&amp;</span> <span class="hl kwd">next</span><span class="hl opt">(</span>i<span class="hl opt">).</span>isEmpty<span class="hl opt">)</span>
               count <span class="hl opt">=</span> count <span class="hl opt">+</span> <span class="hl kwd">next</span><span class="hl opt">(</span>i<span class="hl opt">).</span>contiguousEmptyCells
            i <span class="hl opt">=</span> i <span class="hl opt">+</span> <span class="hl num">1</span>
         <span class="hl opt">}</span>

         count <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span> <span class="hl num">0</span> <span class="hl opt">}</span>
   <span class="hl opt">}</span>
<span class="hl opt">}</span>




<span class="hl slc">// PieceCell.scala</span>

<span class="hl kwa">final class</span> PieceCell <span class="hl kwa">extends</span> Cell <span class="hl opt">{</span>
   <span class="hl kwa">val</span> next <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">[</span>PieceCell<span class="hl opt">](</span>Cell<span class="hl opt">.</span>sides<span class="hl opt">)</span>

   <span class="hl kwa">def</span> flip <span class="hl opt">= {</span>
      <span class="hl kwa">var</span> swap <span class="hl opt">=</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> swap

      swap <span class="hl opt">=</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> swap

      swap <span class="hl opt">=</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> swap
   <span class="hl opt">}</span>

   <span class="hl kwa">def</span> rotate <span class="hl opt">= {</span>
      <span class="hl kwa">var</span> swap <span class="hl opt">=</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>E<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NE<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>NW<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>W<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SW<span class="hl opt">) =</span> <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">)</span>
      <span class="hl kwd">next</span><span class="hl opt">(</span>Cell<span class="hl opt">.</span>SE<span class="hl opt">) =</span> swap
   <span class="hl opt">}</span>
<span class="hl opt">}</span>
