<span class="hl com">&quot;* The Computer Language Benchmarks Game</span>
<span class="hl com">    http://benchmarksgame.alioth.debian.org/</span>
<span class="hl com">    contributed by Paolo Bonzini </span>
<span class="hl com">    modified by Andres Valloud *&quot;</span><span class="hl opt">!</span>

<span class="hl kwc">Stream</span> <span class="hl kwb">subclass:</span> <span class="hl kwd">#PiDigitSpigot</span>
    <span class="hl kwb">instanceVariableNames:</span> <span class="hl str">'numer accum denom k'</span>
    <span class="hl kwb">classVariableNames:</span> <span class="hl str">''</span>
    <span class="hl kwb">poolDictionaries:</span> <span class="hl str">''</span>
    <span class="hl kwb">category:</span> <span class="hl str">'Shootout'</span><span class="hl opt">!</span>

<span class="hl opt">!</span><span class="hl kwc">PiDigitSpigot</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'stream'</span><span class="hl opt">!</span>
<span class="hl kwb">atEnd</span>
    <span class="hl opt">^</span><span class="hl kwa">false</span><span class="hl opt">!</span>

<span class="hl kwb">next</span>
    <span class="hl kwd">| digit |</span>
    <span class="hl opt">[</span> <span class="hl kwa">self</span> <span class="hl kwb">step</span><span class="hl opt">. (</span>digit <span class="hl opt">:</span><span class="hl kwb">=</span> <span class="hl kwa">self</span> <span class="hl kwb">extract</span><span class="hl opt">)</span> <span class="hl kwb">isNil</span> <span class="hl opt">]</span> <span class="hl kwb">whileTrue</span><span class="hl opt">.</span>
    <span class="hl kwa">self</span> <span class="hl kwb">eliminate:</span> digit<span class="hl opt">.</span>
    <span class="hl opt">^</span>digit<span class="hl opt">! !</span>

<span class="hl opt">!</span><span class="hl kwc">PiDigitSpigot</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'private'</span><span class="hl opt">!</span>
<span class="hl kwb">initialize</span>
    numer <span class="hl opt">:</span><span class="hl kwb">=</span> denom <span class="hl opt">:</span><span class="hl kwb">=</span> <span class="hl num">1</span><span class="hl opt">.</span>
    k <span class="hl opt">:</span><span class="hl kwb">=</span> accum <span class="hl opt">:</span><span class="hl kwb">=</span> <span class="hl num">0</span><span class="hl opt">.!</span>

<span class="hl kwb">extract</span>
    <span class="hl kwd">| tmp |</span>
    numer &gt; <span class="hl kwb">accum ifTrue:</span> <span class="hl opt">[^</span><span class="hl kwa">nil</span><span class="hl opt">].</span>
    tmp <span class="hl opt">:</span><span class="hl kwb">=</span> numer <span class="hl kwb">+</span> numer <span class="hl kwb">+</span> numer <span class="hl kwb">+</span> accum<span class="hl opt">.</span>
    tmp <span class="hl esc">\\</span> <span class="hl kwb">denom &gt;=</span> <span class="hl opt">(</span>denom <span class="hl kwb">-</span> numer<span class="hl opt">)</span> <span class="hl kwb">ifTrue:</span> <span class="hl opt">[^</span><span class="hl kwa">nil</span><span class="hl opt">].</span>
    <span class="hl opt">^</span>tmp <span class="hl kwb">//</span> denom<span class="hl opt">!</span>

<span class="hl kwb">eliminate:</span> digit
    accum <span class="hl opt">:</span><span class="hl kwb">=</span> accum <span class="hl kwb">-</span> <span class="hl opt">(</span>denom <span class="hl kwb">*</span> digit<span class="hl opt">).</span>
    accum <span class="hl opt">:</span><span class="hl kwb">=</span> accum <span class="hl kwb">*</span> <span class="hl num">10</span><span class="hl opt">.</span>
    numer <span class="hl opt">:</span><span class="hl kwb">=</span> numer <span class="hl kwb">*</span> <span class="hl num">10</span><span class="hl opt">!</span>

<span class="hl kwb">step</span>
    <span class="hl kwd">| y2 |</span>
    k <span class="hl opt">:</span><span class="hl kwb">=</span> k <span class="hl kwb">+</span> <span class="hl num">1</span><span class="hl opt">.</span>
    y2 <span class="hl opt">:</span><span class="hl kwb">=</span> k <span class="hl kwb">*</span> <span class="hl num">2</span> <span class="hl kwb">+</span> <span class="hl num">1</span><span class="hl opt">.</span>
    accum <span class="hl opt">:</span><span class="hl kwb">=</span> <span class="hl opt">(</span>numer <span class="hl kwb">+</span> numer <span class="hl kwb">+</span> accum<span class="hl opt">)</span> <span class="hl kwb">*</span> y2<span class="hl opt">.</span>
    numer <span class="hl opt">:</span><span class="hl kwb">=</span> numer <span class="hl kwb">*</span> k<span class="hl opt">.</span>
    denom <span class="hl opt">:</span><span class="hl kwb">=</span> denom <span class="hl kwb">*</span> y2<span class="hl opt">.! !</span>


<span class="hl opt">!</span><span class="hl kwc">PiDigitSpigot</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'instance creation'</span><span class="hl opt">!</span>
<span class="hl kwb">new</span>
   <span class="hl opt">^</span><span class="hl kwa">super</span> <span class="hl kwb">basicNew initialize</span><span class="hl opt">! !</span>


<span class="hl opt">!</span><span class="hl kwc">Tests</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'benchmarking'</span><span class="hl opt">!</span>
<span class="hl kwb">pidigitsTo:</span> v <span class="hl kwb">width:</span> width <span class="hl kwb">to:</span> output
   <span class="hl kwd">| n i pidigits |</span>
   n <span class="hl opt">:</span><span class="hl kwb">=</span> v<span class="hl opt">.</span>
   i <span class="hl opt">:</span><span class="hl kwb">=</span> <span class="hl num">0</span><span class="hl opt">.</span>
   pidigits <span class="hl opt">:</span><span class="hl kwb">=</span> <span class="hl kwc">PiDigitSpigot</span> <span class="hl kwb">new</span><span class="hl opt">.</span>
   <span class="hl opt">[</span>n &gt; <span class="hl num">0</span><span class="hl opt">]</span> <span class="hl kwb">whileTrue:</span>
      <span class="hl opt">[</span>n &lt; <span class="hl kwb">width</span>
         <span class="hl kwb">ifTrue:</span>
            <span class="hl opt">[</span>n <span class="hl kwb">timesRepeat:</span> <span class="hl opt">[</span>output <span class="hl kwb">nextPut:</span> <span class="hl opt">(</span><span class="hl kwc">Character</span> <span class="hl kwb">digitValue:</span> pidigits <span class="hl kwb">next</span><span class="hl opt">)].</span>
            n <span class="hl kwb">to:</span> width <span class="hl kwb">do:</span> <span class="hl opt">[</span><span class="hl kwd">:each</span> | output <span class="hl kwb">space</span><span class="hl opt">].</span>
            i <span class="hl opt">:</span><span class="hl kwb">=</span> i <span class="hl kwb">+</span> n<span class="hl opt">]</span>
         <span class="hl kwb">ifFalse:</span>
            <span class="hl opt">[</span>width <span class="hl kwb">timesRepeat:</span> <span class="hl opt">[</span>output <span class="hl kwb">nextPut:</span> <span class="hl opt">(</span><span class="hl kwc">Character</span> <span class="hl kwb">digitValue:</span> pidigits <span class="hl kwb">next</span><span class="hl opt">)].</span>
            i <span class="hl opt">:</span><span class="hl kwb">=</span> i <span class="hl kwb">+</span> width<span class="hl opt">].</span>

      output <span class="hl kwb">tab</span><span class="hl opt">;</span> <span class="hl kwb">nextPut:</span> <span class="hl opt">$:;</span> <span class="hl kwb">print:</span> i<span class="hl opt">;</span> <span class="hl kwb">nl</span><span class="hl opt">.</span>

      n <span class="hl opt">:</span><span class="hl kwb">=</span> n <span class="hl kwb">-</span> width<span class="hl opt">]! !</span>


<span class="hl opt">!</span><span class="hl kwc">Tests</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'benchmark scripts'</span><span class="hl opt">!</span>
<span class="hl kwb">pidigits4</span>
   <span class="hl kwa">self</span> <span class="hl kwb">pidigitsTo:</span> <span class="hl kwa">self</span> <span class="hl kwb">arg width:</span> <span class="hl num">10</span> <span class="hl kwb">to:</span> <span class="hl kwa">self</span> <span class="hl kwb">stdout</span><span class="hl opt">.</span>
   <span class="hl opt">^</span><span class="hl str">''</span><span class="hl opt">! !</span>
