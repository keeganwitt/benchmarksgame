<span class="hl com">/* The Computer Language Benchmarks Game</span>
<span class="hl com"> * http://shootout.alioth.debian.org/</span>
<span class="hl com"> *</span>
<span class="hl com"> * contributed by Enotus 2010-11-26</span>
<span class="hl com"> *</span>
<span class="hl com"> */</span>

<span class="hl kwa">import</span> java<span class="hl sym">.</span>io<span class="hl sym">.*;</span>
<span class="hl kwa">import</span> java<span class="hl sym">.</span>util<span class="hl sym">.*;</span>
<span class="hl kwa">import</span> java<span class="hl sym">.</span>util<span class="hl sym">.</span>concurrent<span class="hl sym">.</span>atomic<span class="hl sym">.</span><span class="hl kwc">AtomicInteger</span><span class="hl sym">;</span>

<span class="hl kwa">public final class</span> regexdna <span class="hl sym">{</span>

   <span class="hl kwa">static final class</span> ByteString<span class="hl sym">{</span>
      <span class="hl kwa">final</span> <span class="hl kwb">byte</span><span class="hl sym">[]</span> data<span class="hl sym">;</span>
      <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl kwb">int</span> size<span class="hl sym">){</span>data<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwb">byte</span><span class="hl sym">[</span>size<span class="hl sym">];}</span>
      <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl kwc">String</span> s<span class="hl sym">){</span>data<span class="hl sym">=</span>s<span class="hl sym">.</span><span class="hl kwd">getBytes</span><span class="hl sym">();}</span>
      <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl kwb">byte</span><span class="hl sym">[]</span> od<span class="hl sym">,</span><span class="hl kwb">int</span> op<span class="hl sym">,</span><span class="hl kwb">int</span> ol<span class="hl sym">){</span>data<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwb">byte</span><span class="hl sym">[</span>ol<span class="hl sym">];</span><span class="hl kwc">System</span><span class="hl sym">.</span><span class="hl kwd">arraycopy</span><span class="hl sym">(</span>od<span class="hl sym">,</span> op<span class="hl sym">,</span> data<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> ol<span class="hl sym">);}</span>
      <span class="hl kwb">int</span> <span class="hl kwd">length</span><span class="hl sym">(){</span><span class="hl kwa">return</span> data<span class="hl sym">.</span>length<span class="hl sym">;}</span>
      <span class="hl kwa">public</span> <span class="hl kwc">String</span> <span class="hl kwd">toString</span><span class="hl sym">(){</span><span class="hl kwa">return new</span> <span class="hl kwc">String</span><span class="hl sym">(</span>data<span class="hl sym">);}</span>
      <span class="hl kwa">public</span> <span class="hl kwb">int</span> <span class="hl kwd">hashCode</span><span class="hl sym">(){</span><span class="hl kwa">return</span> <span class="hl kwc">Arrays</span><span class="hl sym">.</span><span class="hl kwd">hashCode</span><span class="hl sym">(</span>data<span class="hl sym">);}</span>
      <span class="hl kwa">public</span> <span class="hl kwb">boolean</span> <span class="hl kwd">equals</span><span class="hl sym">(</span><span class="hl kwc">Object</span> obj<span class="hl sym">){</span>
         <span class="hl kwa">if</span><span class="hl sym">(</span>obj<span class="hl sym">!=</span>null <span class="hl sym">&amp;&amp;</span> <span class="hl kwd">getClass</span><span class="hl sym">()==</span>obj<span class="hl sym">.</span><span class="hl kwd">getClass</span><span class="hl sym">() &amp;&amp;</span> <span class="hl kwc">Arrays</span><span class="hl sym">.</span><span class="hl kwd">equals</span><span class="hl sym">(</span>data<span class="hl sym">, ((</span>ByteString<span class="hl sym">)</span> obj<span class="hl sym">).</span>data<span class="hl sym">))</span> <span class="hl kwa">return</span> true<span class="hl sym">;</span>
         <span class="hl kwa">else return</span> false<span class="hl sym">;</span>
      <span class="hl sym">}</span>
   <span class="hl sym">}</span>
   <span class="hl kwa">static final class</span> ByteBuilder<span class="hl sym">{</span>
      <span class="hl kwb">byte</span><span class="hl sym">[]</span> data<span class="hl sym">;</span><span class="hl kwb">int</span> size<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>
      <span class="hl kwd">ByteBuilder</span><span class="hl sym">(</span><span class="hl kwb">int</span> size<span class="hl sym">){</span>data<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwb">byte</span><span class="hl sym">[</span>size<span class="hl sym">];}</span>
      <span class="hl kwb">int</span> <span class="hl kwd">length</span><span class="hl sym">(){</span><span class="hl kwa">return</span> size<span class="hl sym">;}</span>
      <span class="hl kwb">void</span> <span class="hl kwd">append</span><span class="hl sym">(</span><span class="hl kwb">byte</span><span class="hl sym">[]</span> od<span class="hl sym">,</span><span class="hl kwb">int</span> op<span class="hl sym">,</span><span class="hl kwb">int</span> ol<span class="hl sym">){</span>
         <span class="hl kwa">if</span><span class="hl sym">(</span>data<span class="hl sym">.</span>length<span class="hl sym">&lt;(</span>size<span class="hl sym">+=</span>ol<span class="hl sym">))</span> data<span class="hl sym">=</span><span class="hl kwc">Arrays</span><span class="hl sym">.</span><span class="hl kwd">copyOf</span><span class="hl sym">(</span>data<span class="hl sym">,</span>size<span class="hl sym">*</span><span class="hl num">2</span><span class="hl sym">);</span>
         <span class="hl kwc">System</span><span class="hl sym">.</span><span class="hl kwd">arraycopy</span><span class="hl sym">(</span>od<span class="hl sym">,</span>op<span class="hl sym">,</span>data<span class="hl sym">,</span>size<span class="hl sym">-</span>ol<span class="hl sym">,</span>ol<span class="hl sym">);</span>
      <span class="hl sym">}</span>
      ByteString <span class="hl kwd">toByteString</span><span class="hl sym">(){</span><span class="hl kwa">return new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span>data<span class="hl sym">,</span><span class="hl num">0</span><span class="hl sym">,</span>size<span class="hl sym">);}</span>
   <span class="hl sym">}</span>

   <span class="hl kwa">static final class</span> <span class="hl kwc">Matcher</span><span class="hl sym">{</span>
      <span class="hl kwa">static final</span> <span class="hl kwb">int</span> transSize<span class="hl sym">=</span><span class="hl num">128</span><span class="hl sym">;</span>
      <span class="hl kwa">static final class</span> <span class="hl kwc">State</span><span class="hl sym">{</span>
         <span class="hl kwa">final</span> <span class="hl kwc">State</span><span class="hl sym">[]</span> trans<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">State</span><span class="hl sym">[</span>transSize<span class="hl sym">];</span><span class="hl kwb">boolean</span> isFinal<span class="hl sym">;</span><span class="hl kwb">int</span> start<span class="hl sym">;</span>
         <span class="hl kwb">void</span> <span class="hl kwd">copyFrom</span><span class="hl sym">(</span><span class="hl kwc">State</span> o<span class="hl sym">){</span><span class="hl kwc">System</span><span class="hl sym">.</span><span class="hl kwd">arraycopy</span><span class="hl sym">(</span>o<span class="hl sym">.</span>trans<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> trans<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> transSize<span class="hl sym">);</span>isFinal<span class="hl sym">=</span>o<span class="hl sym">.</span>isFinal<span class="hl sym">;}</span>
      <span class="hl sym">}</span>

      <span class="hl kwa">final</span> <span class="hl kwb">byte</span><span class="hl sym">[]</span> inData<span class="hl sym">;</span><span class="hl kwa">final</span> <span class="hl kwb">int</span> inSize<span class="hl sym">;</span>
      <span class="hl kwa">final</span> <span class="hl kwc">State</span> rootState<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">State</span><span class="hl sym">();</span><span class="hl kwa">final</span> <span class="hl kwc">State</span><span class="hl sym">[]</span> root<span class="hl sym">=</span>rootState<span class="hl sym">.</span>trans<span class="hl sym">;</span>
      <span class="hl kwa">final</span> <span class="hl kwc">State</span><span class="hl sym">[]</span> active<span class="hl sym">;</span><span class="hl kwb">int</span> act<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>

      <span class="hl kwa">private</span> <span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">Character</span><span class="hl sym">&gt;</span> <span class="hl kwd">getCharList</span><span class="hl sym">(</span><span class="hl kwb">char</span> c<span class="hl sym">){</span>
         <span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">Character</span><span class="hl sym">&gt;</span> cc<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">ArrayList</span><span class="hl sym">&lt;</span><span class="hl kwc">Character</span><span class="hl sym">&gt;();</span>
         <span class="hl kwa">if</span><span class="hl sym">(</span>c<span class="hl sym">==</span><span class="hl str">'.'</span><span class="hl sym">){</span>
            <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">int</span> i<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>i<span class="hl sym">&lt;</span>transSize<span class="hl sym">;</span>i<span class="hl sym">++)</span> <span class="hl kwa">if</span><span class="hl sym">(</span>i<span class="hl sym">!=</span><span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl sym">)</span> cc<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">((</span><span class="hl kwb">char</span><span class="hl sym">)</span>i<span class="hl sym">);</span>
         <span class="hl sym">}</span><span class="hl kwa">else if</span><span class="hl sym">(</span><span class="hl kwc">Character</span><span class="hl sym">.</span><span class="hl kwd">isLetter</span><span class="hl sym">(</span>c<span class="hl sym">)){</span>
            cc<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span><span class="hl kwc">Character</span><span class="hl sym">.</span><span class="hl kwd">toLowerCase</span><span class="hl sym">(</span>c<span class="hl sym">));</span>
            cc<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span><span class="hl kwc">Character</span><span class="hl sym">.</span><span class="hl kwd">toUpperCase</span><span class="hl sym">(</span>c<span class="hl sym">));</span>
         <span class="hl sym">}</span><span class="hl kwa">else</span><span class="hl sym">{</span>
            cc<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span>c<span class="hl sym">);</span>
         <span class="hl sym">}</span>
         <span class="hl kwa">return</span> cc<span class="hl sym">;</span>
      <span class="hl sym">}</span>
      
      <span class="hl kwb">int</span> <span class="hl kwd">addBar</span><span class="hl sym">(</span><span class="hl kwc">String</span> pattern<span class="hl sym">,</span><span class="hl kwb">int</span> index<span class="hl sym">,</span><span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;</span> ss<span class="hl sym">){</span>
         <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwc">State</span> s<span class="hl sym">:</span>ss<span class="hl sym">)</span>s<span class="hl sym">.</span>isFinal<span class="hl sym">=</span>true<span class="hl sym">;</span>
         ss<span class="hl sym">.</span><span class="hl kwd">clear</span><span class="hl sym">();</span>ss<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span>rootState<span class="hl sym">);</span>
         <span class="hl kwa">return</span> index<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">;</span>
      <span class="hl sym">}</span>
      <span class="hl kwb">int</span> <span class="hl kwd">addPar</span><span class="hl sym">(</span><span class="hl kwc">String</span> pattern<span class="hl sym">,</span><span class="hl kwb">int</span> index<span class="hl sym">,</span><span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;</span> ss<span class="hl sym">){</span>
         <span class="hl kwc">State</span> ns<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">State</span><span class="hl sym">();</span>
         <span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;</span> nss<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">ArrayList</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;();</span>nss<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span>ns<span class="hl sym">);</span>
         index<span class="hl sym">++;</span>
         <span class="hl kwb">char</span> pc<span class="hl sym">;</span>
         <span class="hl kwa">while</span><span class="hl sym">((</span>pc<span class="hl sym">=</span>pattern<span class="hl sym">.</span><span class="hl kwd">charAt</span><span class="hl sym">(</span>index<span class="hl sym">++))!=</span><span class="hl str">']'</span><span class="hl sym">){</span>
            <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">char</span> c<span class="hl sym">:</span><span class="hl kwd">getCharList</span><span class="hl sym">(</span>pc<span class="hl sym">))</span>
               <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwc">State</span> s<span class="hl sym">:</span>ss<span class="hl sym">)</span>
                  <span class="hl kwa">if</span><span class="hl sym">(</span>s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]!=</span>null<span class="hl sym">)</span>nss<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span>s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]);</span>
                  <span class="hl kwa">else</span> s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]=</span>ns<span class="hl sym">;</span>
         <span class="hl sym">}</span>
         ss<span class="hl sym">.</span><span class="hl kwd">clear</span><span class="hl sym">();</span>ss<span class="hl sym">.</span><span class="hl kwd">addAll</span><span class="hl sym">(</span>nss<span class="hl sym">);</span>
         <span class="hl kwa">return</span> index<span class="hl sym">;</span>
      <span class="hl sym">}</span>
      <span class="hl kwb">int</span> <span class="hl kwd">addPointStar</span><span class="hl sym">(</span><span class="hl kwc">String</span> pattern<span class="hl sym">,</span><span class="hl kwb">int</span> index<span class="hl sym">,</span><span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;</span> ss<span class="hl sym">){</span>
         <span class="hl kwc">State</span> ns<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">State</span><span class="hl sym">();</span>
         ss<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span>ns<span class="hl sym">);</span>
         <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">char</span> c<span class="hl sym">:</span><span class="hl kwd">getCharList</span><span class="hl sym">(</span>pattern<span class="hl sym">.</span><span class="hl kwd">charAt</span><span class="hl sym">(</span>index<span class="hl sym">)))</span>
            <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwc">State</span> s<span class="hl sym">:</span>ss<span class="hl sym">){</span>
               <span class="hl kwa">if</span><span class="hl sym">(</span>s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]!=</span>null<span class="hl sym">)</span>ns<span class="hl sym">.</span><span class="hl kwd">copyFrom</span><span class="hl sym">(</span>s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]);</span>
               s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]=</span>ns<span class="hl sym">;</span>
            <span class="hl sym">}</span>
         <span class="hl kwa">return</span> index<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">;</span>
      <span class="hl sym">}</span>
      <span class="hl kwb">int</span> <span class="hl kwd">addCharConcat</span><span class="hl sym">(</span><span class="hl kwc">String</span> pattern<span class="hl sym">,</span><span class="hl kwb">int</span> index<span class="hl sym">,</span><span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;</span> ss<span class="hl sym">){</span>
         <span class="hl kwc">State</span> ns<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">State</span><span class="hl sym">();</span>
         <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">char</span> c<span class="hl sym">:</span><span class="hl kwd">getCharList</span><span class="hl sym">(</span>pattern<span class="hl sym">.</span><span class="hl kwd">charAt</span><span class="hl sym">(</span>index<span class="hl sym">)))</span>
            <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwc">State</span> s<span class="hl sym">:</span>ss<span class="hl sym">){</span>
               <span class="hl kwa">if</span><span class="hl sym">(</span>s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]!=</span>null<span class="hl sym">)</span>ns<span class="hl sym">.</span><span class="hl kwd">copyFrom</span><span class="hl sym">(</span>s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]);</span>
               s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">]=</span>ns<span class="hl sym">;</span>
            <span class="hl sym">}</span>
         ss<span class="hl sym">.</span><span class="hl kwd">clear</span><span class="hl sym">();</span>ss<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span>ns<span class="hl sym">);</span>
         <span class="hl kwa">return</span> index<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">;</span>
      <span class="hl sym">}</span>
      <span class="hl kwc">Matcher</span><span class="hl sym">(</span><span class="hl kwc">String</span> pattern<span class="hl sym">,</span>ByteString ins<span class="hl sym">){</span>
         <span class="hl kwc">List</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;</span> ss<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">ArrayList</span><span class="hl sym">&lt;</span><span class="hl kwc">State</span><span class="hl sym">&gt;();</span>
         ss<span class="hl sym">.</span><span class="hl kwd">add</span><span class="hl sym">(</span>rootState<span class="hl sym">);</span>
         
         <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">int</span> i<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>i<span class="hl sym">&lt;</span>pattern<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">();){</span>
            <span class="hl kwa">if</span><span class="hl sym">(</span>pattern<span class="hl sym">.</span><span class="hl kwd">charAt</span><span class="hl sym">(</span>i<span class="hl sym">)==</span><span class="hl str">'|'</span><span class="hl sym">){</span>
               i<span class="hl sym">=</span><span class="hl kwd">addBar</span><span class="hl sym">(</span>pattern<span class="hl sym">,</span>i<span class="hl sym">,</span>ss<span class="hl sym">);</span>
            <span class="hl sym">}</span><span class="hl kwa">else if</span><span class="hl sym">(</span>pattern<span class="hl sym">.</span><span class="hl kwd">charAt</span><span class="hl sym">(</span>i<span class="hl sym">)==</span><span class="hl str">'['</span><span class="hl sym">){</span>
               i<span class="hl sym">=</span><span class="hl kwd">addPar</span><span class="hl sym">(</span>pattern<span class="hl sym">,</span>i<span class="hl sym">,</span>ss<span class="hl sym">);</span>
            <span class="hl sym">}</span><span class="hl kwa">else if</span><span class="hl sym">(</span>pattern<span class="hl sym">.</span><span class="hl kwd">charAt</span><span class="hl sym">(</span>i<span class="hl sym">)==</span><span class="hl str">'.'</span> <span class="hl sym">&amp;&amp;</span> i<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">&lt;</span>pattern<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">() &amp;&amp;</span> pattern<span class="hl sym">.</span><span class="hl kwd">charAt</span><span class="hl sym">(</span>i<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)==</span><span class="hl str">'*'</span><span class="hl sym">){</span>
               i<span class="hl sym">=</span><span class="hl kwd">addPointStar</span><span class="hl sym">(</span>pattern<span class="hl sym">,</span>i<span class="hl sym">,</span>ss<span class="hl sym">);</span>
            <span class="hl sym">}</span><span class="hl kwa">else</span><span class="hl sym">{</span>
               i<span class="hl sym">=</span><span class="hl kwd">addCharConcat</span><span class="hl sym">(</span>pattern<span class="hl sym">,</span>i<span class="hl sym">,</span>ss<span class="hl sym">);</span>
            <span class="hl sym">}</span>
         <span class="hl sym">}</span>
         <span class="hl kwd">addBar</span><span class="hl sym">(</span>pattern<span class="hl sym">,</span><span class="hl num">0</span><span class="hl sym">,</span>ss<span class="hl sym">);</span>

         active<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">State</span><span class="hl sym">[</span>pattern<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">()];</span>
         inData<span class="hl sym">=</span>ins<span class="hl sym">.</span>data<span class="hl sym">;</span>inSize<span class="hl sym">=</span>inData<span class="hl sym">.</span>length<span class="hl sym">;</span>
      <span class="hl sym">}</span>

      <span class="hl kwb">int</span> start<span class="hl sym">=-</span><span class="hl num">1</span><span class="hl sym">;</span>
      <span class="hl kwb">int</span> <span class="hl kwd">startFind</span><span class="hl sym">(</span><span class="hl kwb">int</span> index<span class="hl sym">){</span>
         <span class="hl kwa">while</span><span class="hl sym">(</span>index<span class="hl sym">&lt;</span>inSize<span class="hl sym">){</span>
            <span class="hl kwb">int</span> c<span class="hl sym">=</span>inData<span class="hl sym">[</span>index<span class="hl sym">++];</span>

            <span class="hl kwb">int</span> nct<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>
            <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">int</span> ct<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>ct<span class="hl sym">&lt;</span>act<span class="hl sym">;</span>ct<span class="hl sym">++){</span>
               <span class="hl kwc">State</span> s<span class="hl sym">=</span>active<span class="hl sym">[</span>ct<span class="hl sym">];</span><span class="hl kwc">State</span> ns<span class="hl sym">=</span>s<span class="hl sym">.</span>trans<span class="hl sym">[</span>c<span class="hl sym">];</span>
               <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">!=</span>null<span class="hl sym">)</span>   <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">.</span>isFinal<span class="hl sym">){</span>act<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>start<span class="hl sym">=</span>s<span class="hl sym">.</span>start<span class="hl sym">;</span><span class="hl kwa">return</span> index<span class="hl sym">;}</span>
                           <span class="hl kwa">else</span><span class="hl sym">{</span>ns<span class="hl sym">.</span>start<span class="hl sym">=</span>s<span class="hl sym">.</span>start<span class="hl sym">;</span>active<span class="hl sym">[</span>nct<span class="hl sym">++]=</span>ns<span class="hl sym">;}</span>
            <span class="hl sym">}</span>
            act<span class="hl sym">=</span>nct<span class="hl sym">;</span>

            <span class="hl kwc">State</span> ns<span class="hl sym">=</span>root<span class="hl sym">[</span>c<span class="hl sym">];</span>
            <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">!=</span>null<span class="hl sym">)</span>   <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">.</span>isFinal<span class="hl sym">){</span>act<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>start<span class="hl sym">=</span>index<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">;</span><span class="hl kwa">return</span> index<span class="hl sym">;}</span>
                        <span class="hl kwa">else</span><span class="hl sym">{</span>ns<span class="hl sym">.</span>start<span class="hl sym">=</span>index<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">;</span>active<span class="hl sym">[</span>act<span class="hl sym">++]=</span>ns<span class="hl sym">;}</span>
         <span class="hl sym">}</span>
         <span class="hl kwa">return</span> <span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">;</span>
      <span class="hl sym">}</span>
      
      <span class="hl kwb">int</span> <span class="hl kwd">find</span><span class="hl sym">(</span><span class="hl kwb">int</span> index<span class="hl sym">){</span>
         <span class="hl kwa">while</span><span class="hl sym">(</span>index<span class="hl sym">&lt;</span>inSize<span class="hl sym">){</span>
            <span class="hl kwb">int</span> c0<span class="hl sym">=</span>inData<span class="hl sym">[</span>index<span class="hl sym">++];</span>

            <span class="hl kwb">int</span> nct<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>
            <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">int</span> ct<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>ct<span class="hl sym">&lt;</span>act<span class="hl sym">;</span>ct<span class="hl sym">++){</span>
               <span class="hl kwc">State</span> ns<span class="hl sym">=</span>active<span class="hl sym">[</span>ct<span class="hl sym">].</span>trans<span class="hl sym">[</span>c0<span class="hl sym">];</span>
               <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">!=</span>null<span class="hl sym">)</span>   <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">.</span>isFinal<span class="hl sym">){</span>act<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span> <span class="hl kwa">return</span> index<span class="hl sym">;}</span>
                           <span class="hl kwa">else</span> active<span class="hl sym">[</span>nct<span class="hl sym">++]=</span>ns<span class="hl sym">;</span>
            <span class="hl sym">}</span>
            act<span class="hl sym">=</span>nct<span class="hl sym">;</span>

            <span class="hl kwc">State</span> ns<span class="hl sym">=</span>root<span class="hl sym">[</span>c0<span class="hl sym">];</span>
            <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">!=</span>null<span class="hl sym">)</span>   <span class="hl kwa">if</span><span class="hl sym">(</span>ns<span class="hl sym">.</span>isFinal<span class="hl sym">){</span>act<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span> <span class="hl kwa">return</span> index<span class="hl sym">;}</span>
                        <span class="hl kwa">else</span> active<span class="hl sym">[</span>act<span class="hl sym">++]=</span>ns<span class="hl sym">;</span>
         <span class="hl sym">}</span>
         <span class="hl kwa">return</span> <span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">;</span>
      <span class="hl sym">}</span>
   <span class="hl sym">}</span>


   <span class="hl kwa">static final</span> <span class="hl kwc">String</span><span class="hl sym">[]</span> pat1<span class="hl sym">={</span><span class="hl str">&quot;agggtaaa|tttaccct&quot;</span><span class="hl sym">,</span> <span class="hl str">&quot;[cgt]gggtaaa|tttaccc[acg]&quot;</span><span class="hl sym">,</span>
      <span class="hl str">&quot;a[act]ggtaaa|tttacc[agt]t&quot;</span><span class="hl sym">,</span> <span class="hl str">&quot;ag[act]gtaaa|tttac[agt]ct&quot;</span><span class="hl sym">,</span>
      <span class="hl str">&quot;agg[act]taaa|ttta[agt]cct&quot;</span><span class="hl sym">,</span> <span class="hl str">&quot;aggg[acg]aaa|ttt[cgt]ccct&quot;</span><span class="hl sym">,</span>
      <span class="hl str">&quot;agggt[cgt]aa|tt[acg]accct&quot;</span><span class="hl sym">,</span> <span class="hl str">&quot;agggta[cgt]a|t[acg]taccct&quot;</span><span class="hl sym">,</span>
      <span class="hl str">&quot;agggtaa[cgt]|[acg]ttaccct&quot;</span><span class="hl sym">};</span>
   <span class="hl kwa">static final</span> <span class="hl kwc">Map</span><span class="hl sym">&lt;</span>ByteString<span class="hl sym">,</span>ByteString<span class="hl sym">&gt;</span> pat2 <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwc">HashMap</span><span class="hl sym">&lt;</span>ByteString<span class="hl sym">,</span>ByteString<span class="hl sym">&gt;();</span>
      <span class="hl kwa">static</span><span class="hl sym">{</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;W&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(a|t)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;Y&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(c|t)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;K&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(g|t)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;M&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(a|c)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;S&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(c|g)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;R&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(a|g)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;B&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(c|g|t)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;D&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(a|g|t)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;V&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(a|c|g)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;H&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(a|c|t)&quot;</span><span class="hl sym">));</span>
      pat2<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;N&quot;</span><span class="hl sym">),</span> <span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span><span class="hl str">&quot;(a|c|g|t)&quot;</span><span class="hl sym">));</span>
   <span class="hl sym">}</span>
   <span class="hl kwa">static final</span> <span class="hl kwc">AtomicInteger</span> pat1Ct<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">AtomicInteger</span><span class="hl sym">();</span>
   
   <span class="hl kwa">public static</span> <span class="hl kwb">void</span> <span class="hl kwd">main</span><span class="hl sym">(</span><span class="hl kwc">String</span><span class="hl sym">[]</span> args<span class="hl sym">)</span> <span class="hl kwa">throws</span> <span class="hl kwc">Exception</span> <span class="hl sym">{</span>
      <span class="hl kwa">final</span> ByteString s1<span class="hl sym">;</span><span class="hl kwb">int</span> s1Size<span class="hl sym">;{</span>
         s1Size<span class="hl sym">=</span><span class="hl kwc">System</span><span class="hl sym">.</span><span class="hl kwa">in</span><span class="hl sym">.</span><span class="hl kwd">available</span><span class="hl sym">();</span>
         s1<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span>s1Size<span class="hl sym">);</span>
         <span class="hl kwc">System</span><span class="hl sym">.</span><span class="hl kwa">in</span><span class="hl sym">.</span><span class="hl kwd">read</span><span class="hl sym">(</span>s1<span class="hl sym">.</span>data<span class="hl sym">);</span>
      <span class="hl sym">}</span>

      <span class="hl kwa">final</span> ByteString s2<span class="hl sym">;</span><span class="hl kwb">int</span> s2Size<span class="hl sym">;{</span>
         ByteBuilder bb<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwd">ByteBuilder</span><span class="hl sym">(</span>s1Size<span class="hl sym">);</span>
         <span class="hl kwc">Matcher</span> m<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">Matcher</span><span class="hl sym">(</span><span class="hl str">&quot;&gt;.*</span><span class="hl esc">\n</span><span class="hl str">|</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl sym">,</span> s1<span class="hl sym">);</span>
         <span class="hl kwb">int</span> inPos<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">,</span>index<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>
         <span class="hl kwa">while</span><span class="hl sym">((</span>index<span class="hl sym">=</span>m<span class="hl sym">.</span><span class="hl kwd">startFind</span><span class="hl sym">(</span>index<span class="hl sym">))&gt;=</span><span class="hl num">0</span><span class="hl sym">){</span>
            bb<span class="hl sym">.</span><span class="hl kwd">append</span><span class="hl sym">(</span>s1<span class="hl sym">.</span>data<span class="hl sym">,</span> inPos<span class="hl sym">,</span> m<span class="hl sym">.</span>start<span class="hl sym">-</span>inPos<span class="hl sym">);</span>
            inPos<span class="hl sym">=</span>index<span class="hl sym">;</span>
         <span class="hl sym">}</span>
         bb<span class="hl sym">.</span><span class="hl kwd">append</span><span class="hl sym">(</span>s1<span class="hl sym">.</span>data<span class="hl sym">,</span> inPos<span class="hl sym">,</span> s1<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">()-</span>inPos<span class="hl sym">);</span>
         s2<span class="hl sym">=</span>bb<span class="hl sym">.</span><span class="hl kwd">toByteString</span><span class="hl sym">();</span>
         s2Size<span class="hl sym">=</span>s2<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">();</span>
      <span class="hl sym">}</span>

      <span class="hl kwa">final</span> <span class="hl kwb">int</span><span class="hl sym">[]</span> pat1res<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwb">int</span><span class="hl sym">[</span>pat1<span class="hl sym">.</span>length<span class="hl sym">];{</span>
         <span class="hl kwc">Thread</span><span class="hl sym">[]</span> pool<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">Thread</span><span class="hl sym">[</span>pat1<span class="hl sym">.</span>length<span class="hl sym">];</span>
         <span class="hl kwa">for</span> <span class="hl sym">(</span><span class="hl kwb">int</span> i<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>i<span class="hl sym">&lt;</span>pool<span class="hl sym">.</span>length<span class="hl sym">;</span>i<span class="hl sym">++)</span>
            pool<span class="hl sym">[</span>i<span class="hl sym">]=</span><span class="hl kwa">new</span> <span class="hl kwc">Thread</span><span class="hl sym">(){</span>
               <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">run</span><span class="hl sym">() {</span>
                   <span class="hl kwb">int</span> r<span class="hl sym">;</span> <span class="hl kwa">while</span><span class="hl sym">((</span>r<span class="hl sym">=</span>pat1Ct<span class="hl sym">.</span><span class="hl kwd">getAndIncrement</span><span class="hl sym">())&lt;</span>pat1res<span class="hl sym">.</span>length<span class="hl sym">){</span>
                     <span class="hl kwc">Matcher</span> m<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">Matcher</span><span class="hl sym">(</span>pat1<span class="hl sym">[</span>r<span class="hl sym">],</span>s2<span class="hl sym">);</span>
                     <span class="hl kwb">int</span> count<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">,</span>index<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span><span class="hl kwa">while</span><span class="hl sym">((</span>index<span class="hl sym">=</span>m<span class="hl sym">.</span><span class="hl kwd">find</span><span class="hl sym">(</span>index<span class="hl sym">))&gt;=</span><span class="hl num">0</span><span class="hl sym">)</span> count<span class="hl sym">++;</span>
                     pat1res<span class="hl sym">[</span>r<span class="hl sym">]=</span>count<span class="hl sym">;</span>
                   <span class="hl sym">}</span>
               <span class="hl sym">}</span>
            <span class="hl sym">};</span>
         <span class="hl kwa">for</span> <span class="hl sym">(</span><span class="hl kwc">Thread</span> t<span class="hl sym">:</span>pool<span class="hl sym">)</span> t<span class="hl sym">.</span><span class="hl kwd">start</span><span class="hl sym">();</span>
         <span class="hl kwa">for</span> <span class="hl sym">(</span><span class="hl kwc">Thread</span> t<span class="hl sym">:</span>pool<span class="hl sym">)</span> t<span class="hl sym">.</span><span class="hl kwd">join</span><span class="hl sym">();</span>
      <span class="hl sym">}</span>

      <span class="hl kwb">int</span> s3Size<span class="hl sym">;{</span>
         ByteBuilder bb<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwd">ByteBuilder</span><span class="hl sym">(</span>s1Size<span class="hl sym">*</span><span class="hl num">3</span><span class="hl sym">/</span><span class="hl num">2</span><span class="hl sym">);</span>
         <span class="hl kwc">Matcher</span> m<span class="hl sym">=</span><span class="hl kwa">new</span> <span class="hl kwc">Matcher</span><span class="hl sym">(</span><span class="hl str">&quot;[WYKMSRBDVHN]&quot;</span><span class="hl sym">,</span> s2<span class="hl sym">);</span>
         <span class="hl kwb">int</span> inPos<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">,</span>index<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>
         <span class="hl kwa">while</span><span class="hl sym">((</span>index<span class="hl sym">=</span>m<span class="hl sym">.</span><span class="hl kwd">startFind</span><span class="hl sym">(</span>index<span class="hl sym">))&gt;=</span><span class="hl num">0</span><span class="hl sym">){</span>
            bb<span class="hl sym">.</span><span class="hl kwd">append</span><span class="hl sym">(</span>s2<span class="hl sym">.</span>data<span class="hl sym">,</span> inPos<span class="hl sym">,</span> m<span class="hl sym">.</span>start<span class="hl sym">-</span>inPos<span class="hl sym">);</span>
            ByteString rep<span class="hl sym">=</span>pat2<span class="hl sym">.</span><span class="hl kwd">get</span><span class="hl sym">(</span><span class="hl kwa">new</span> <span class="hl kwd">ByteString</span><span class="hl sym">(</span>s2<span class="hl sym">.</span>data<span class="hl sym">,</span>m<span class="hl sym">.</span>start<span class="hl sym">,</span>index<span class="hl sym">-</span>m<span class="hl sym">.</span>start<span class="hl sym">));</span>
            bb<span class="hl sym">.</span><span class="hl kwd">append</span><span class="hl sym">(</span>rep<span class="hl sym">.</span>data<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> rep<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">());</span>
            inPos<span class="hl sym">=</span>index<span class="hl sym">;</span>
         <span class="hl sym">}</span>
         bb<span class="hl sym">.</span><span class="hl kwd">append</span><span class="hl sym">(</span>s2<span class="hl sym">.</span>data<span class="hl sym">,</span> inPos<span class="hl sym">,</span> s2<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">()-</span>inPos<span class="hl sym">);</span>
         s3Size<span class="hl sym">=</span>bb<span class="hl sym">.</span><span class="hl kwd">length</span><span class="hl sym">();</span>
      <span class="hl sym">}</span>

      <span class="hl kwa">for</span><span class="hl sym">(</span><span class="hl kwb">int</span> i<span class="hl sym">=</span><span class="hl num">0</span><span class="hl sym">;</span>i<span class="hl sym">&lt;</span>pat1<span class="hl sym">.</span>length<span class="hl sym">;</span>i<span class="hl sym">++)</span><span class="hl kwc">System</span><span class="hl sym">.</span>out<span class="hl sym">.</span><span class="hl kwd">println</span><span class="hl sym">(</span>pat1<span class="hl sym">[</span>i<span class="hl sym">]+</span><span class="hl str">&quot; &quot;</span><span class="hl sym">+</span>pat1res<span class="hl sym">[</span>i<span class="hl sym">]);</span>
      <span class="hl kwc">System</span><span class="hl sym">.</span>out<span class="hl sym">.</span><span class="hl kwd">println</span><span class="hl sym">();</span>
      <span class="hl kwc">System</span><span class="hl sym">.</span>out<span class="hl sym">.</span><span class="hl kwd">println</span><span class="hl sym">(</span>s1Size<span class="hl sym">);</span>
      <span class="hl kwc">System</span><span class="hl sym">.</span>out<span class="hl sym">.</span><span class="hl kwd">println</span><span class="hl sym">(</span>s2Size<span class="hl sym">);</span>
      <span class="hl kwc">System</span><span class="hl sym">.</span>out<span class="hl sym">.</span><span class="hl kwd">println</span><span class="hl sym">(</span>s3Size<span class="hl sym">);</span>
   <span class="hl sym">}</span>
<span class="hl sym">}</span>
